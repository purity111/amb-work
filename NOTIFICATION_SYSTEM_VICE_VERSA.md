# 双方向通知システム 実装ドキュメント

## 概要
求職者と企業の両方向でリアルタイム通知システムを実装しました。求職者が応募した際の企業への通知に加えて、企業が応募に回答した際の求職者への通知も実装されています。

## 双方向通知フロー

### 1. 求職者 → 企業の通知

#### 応募通知
- **トリガー**: 求職者が求人に応募
- **企業への通知**: 「新しい応募: [求職者名]さんから「[求人タイトル]」への応募がありました」
- **バッジ表示**: 応募管理メニューに赤いバッジ
- **自動クリア**: 企業が応募管理ページ訪問時

#### メッセージ通知
- **トリガー**: 求職者が企業にメッセージ送信
- **企業への通知**: 「新しいメッセージ: [求職者名]さんからメッセージが届きました」
- **バッジ表示**: チャット管理メニューに赤いバッジ
- **自動クリア**: 企業がチャット管理ページ訪問時

### 2. 企業 → 求職者の通知

#### 応募結果通知
- **トリガー**: 企業が応募結果を更新（採用/不採用/検討中）
- **求職者への通知**: 「応募結果: [企業名]から「[求人タイトル]」の応募結果（[結果]）が届きました」
- **バッジ表示**: 応募管理メニューに赤いバッジ
- **自動クリア**: 求職者が応募管理ページ訪問時

#### メッセージ通知
- **トリガー**: 企業が求職者にメッセージ送信
- **求職者への通知**: 「新しいメッセージ: [企業名]からメッセージが届きました」
- **バッジ表示**: チャット管理メニューに赤いバッジ
- **自動クリア**: 求職者がチャット管理ページ訪問時

## 実装内容

### 1. 通知コンテキストの拡張

#### 新しい通知関数
```typescript
// 企業の応募結果通知（求職者向け）
showApplicationResponseNotification: (companyName: string, jobTitle: string, status: string) => void;
```

#### 役割別メッセージ
```typescript
// 応募通知（役割によって異なるメッセージ）
const message = profile?.role === 'Employer' || profile?.role === 'admin'
  ? `新しい応募: ${applicantName}さんから「${jobTitle}」への応募がありました`
  : `応募結果: 「${jobTitle}」への応募が企業に送信されました`;

// メッセージ通知（役割によって異なるメッセージ）
const message = profile?.role === 'Employer' || profile?.role === 'admin'
  ? `新しいメッセージ: ${senderName}さんからメッセージが届きました`
  : `新しいメッセージ: ${senderName}からメッセージが届きました`;
```

### 2. バッジ表示の拡張

#### 全ユーザー対応
- **以前**: 企業・管理者のみ
- **現在**: 求職者・企業・管理者すべて

#### 条件付き表示
```typescript
// 求職者向けの特別なロジック
if (profile.role === 'JobSeeker') {
  // 求職者は応募結果とメッセージを見る
  if (type === 'application' && pathname === '/mypage/application_mng') {
    return null;
  }
  if (type === 'message' && pathname === '/mypage/chat_mng') {
    return null;
  }
}
```

### 3. 応募結果通知システム

#### 新しいフック
```typescript
// useApplicationResponse.tsx
export function useApplicationResponse() {
  const simulateApplicationResponse = (
    companyName: string,
    jobTitle: string,
    status: 'accepted' | 'rejected' | 'pending'
  ) => {
    if (profile?.role === 'JobSeeker') {
      showApplicationResponseNotification(companyName, jobTitle, status);
      updateApplicationCount(1);
    }
  };
}
```

#### テスト機能
- 求職者の応募管理ページに「応募結果テスト」ボタン
- 複数の応募結果をシミュレート
- 採用・不採用・検討中の異なる結果をテスト

### 4. チャット通知の拡張

#### 双方向メッセージ通知
```typescript
// 送信者名の動的決定
const senderName = message.sender_name || (profile.role === 'JobSeeker' ? '企業' : '求職者');
```

## ユーザー体験フロー

### 求職者の体験

#### 応募後の通知
1. **応募送信**: 求職者が求人に応募
2. **確認通知**: 「応募結果: 「[求人タイトル]」への応募が企業に送信されました」
3. **待機**: 企業からの回答を待つ

#### 企業からの回答受信
1. **企業が回答**: 企業が応募結果を更新
2. **結果通知**: 「応募結果: [企業名]から「[求人タイトル]」の応募結果（採用）が届きました」
3. **バッジ表示**: 応募管理メニューに赤いバッジ
4. **確認**: 求職者が応募管理ページで詳細確認

#### 企業からのメッセージ受信
1. **メッセージ受信**: 企業が求職者にメッセージ送信
2. **通知表示**: 「新しいメッセージ: [企業名]からメッセージが届きました」
3. **バッジ表示**: チャット管理メニューに赤いバッジ
4. **返信**: 求職者がチャット管理ページで返信

### 企業の体験

#### 求職者からの応募受信
1. **応募受信**: 求職者が求人に応募
2. **通知表示**: 「新しい応募: [求職者名]さんから「[求人タイトル]」への応募がありました」
3. **バッジ表示**: 応募管理メニューに赤いバッジ
4. **対応**: 企業が応募管理ページで応募を確認・回答

#### 求職者からのメッセージ受信
1. **メッセージ受信**: 求職者が企業にメッセージ送信
2. **通知表示**: 「新しいメッセージ: [求職者名]さんからメッセージが届きました」
3. **バッジ表示**: チャット管理メニューに赤いバッジ
4. **返信**: 企業がチャット管理ページで返信

## 技術実装

### 通知状態管理
```typescript
interface NotificationCounts {
  applications: number;  // 応募関連の通知数
  messages: number;      // メッセージ関連の通知数
  total: number;         // 合計通知数
}
```

### 役割別通知ロジック
```typescript
// 企業・管理者向け
if (profile?.role === 'Employer' || profile?.role === 'admin') {
  // 求職者からの応募・メッセージ通知
}

// 求職者向け
if (profile?.role === 'JobSeeker') {
  // 企業からの応募結果・メッセージ通知
}
```

### 自動クリーンアップ
```typescript
// 全ユーザー対応
useEffect(() => {
  if (!profile || !profile.role) return;
  
  if (pathname === '/mypage/application_mng') {
    clearApplicationCount();
  }
  
  if (pathname === '/mypage/chat_mng') {
    clearMessageCount();
  }
}, [pathname, profile?.role]);
```

## テスト機能

### 求職者向けテスト
- **応募結果テストボタン**: 応募管理ページに配置
- **複数結果シミュレート**: 採用・不採用・検討中の異なる結果
- **タイミング制御**: 1秒、3秒、5秒間隔で通知

### 企業向けテスト
- **応募通知**: 求職者が応募時に自動通知
- **メッセージ通知**: Socket.IO によるリアルタイム通知

## セキュリティとプライバシー

### アクセス制御
- 適切なユーザー認証チェック
- 役割ベースの通知表示制御
- 個人情報の適切な処理

### データ保護
- 通知内容の最小限化
- 適切な情報の表示制御
- セッション管理

## パフォーマンス最適化

### 効率的な更新
- 必要な時のみ通知更新
- 不要な再レンダリングの防止
- メモ化の活用

### メモリ管理
- 適切なクリーンアップ
- イベントリスナーの適切な削除
- メモリリークの防止

## 今後の拡張予定

### 機能拡張
- プッシュ通知の統合
- 通知履歴の表示
- 通知設定のカスタマイズ
- 音声通知の追加

### 技術改善
- 真のリアルタイム通知
- 通知キューの実装
- パフォーマンスの最適化
- アクセシビリティの向上

## まとめ

この双方向通知システムにより、求職者と企業の両方が効率的なコミュニケーションを実現できます。応募から採用までの全プロセスで、適切なタイミングで通知が届き、見逃しを防ぐことができます。


