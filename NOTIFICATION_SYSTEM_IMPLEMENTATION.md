# リアルタイム通知システム 実装ドキュメント

## 概要
求職者の応募やメッセージ送信時に、企業アカウントに対してリアルタイムでバッジ表示とトースト通知を行うシステムを実装しました。

## 実装内容

### 1. 通知コンテキスト (`src/hooks/useNotificationContext.tsx`)
- リアルタイム通知状態の管理
- バッジカウントの管理（応募数、メッセージ数、合計数）
- トースト通知の表示機能
- localStorage による設定の永続化

### 2. 通知バッジコンポーネント (`src/components/NotificationBadge.tsx`)
- 個別バッジ（応募管理、チャット管理）
- 統合バッジ（ヘッダーアバター用）
- 条件付き表示（現在のページ、ユーザーロール）

### 3. サイドバー統合 (`src/components/Sidebar.tsx`)
- 応募管理メニューに応募数のバッジ表示
- チャット管理メニューにメッセージ数のバッジ表示
- 企業・管理者のみ表示

### 4. ヘッダーアバター統合 (`src/components/HeaderAvatar.tsx`)
- マイページ外での統合バッジ表示
- 応募数とメッセージ数の合計表示

### 5. 通知クリーンアップ機能 (`src/hooks/useNotificationCleanup.tsx`)
- 関連ページ訪問時の自動バッジクリア
- 応募管理ページ訪問時の応募バッジクリア
- チャット管理ページ訪問時のメッセージバッジクリア

## 機能仕様

### バッジ表示ルール

#### サイドバー内（マイページ）
- **応募管理**: 応募数のバッジ表示（応募管理ページ以外）
- **チャット管理**: メッセージ数のバッジ表示（チャット管理ページ以外）
- **表示対象**: 企業・管理者のみ

#### ヘッダーアバター（マイページ外）
- **統合バッジ**: 応募数 + メッセージ数の合計表示
- **表示条件**: マイページ外でのみ表示
- **表示対象**: 企業・管理者のみ

### トースト通知
- **応募通知**: 「新しい応募: [求職者名]さんから「[求人タイトル]」への応募がありました」
- **メッセージ通知**: 「新しいメッセージ: [送信者名]さんからメッセージが届きました」
- **表示位置**: 右上
- **自動消去**: 5秒後

### 自動クリア機能
- **応募管理ページ訪問**: 応募バッジ自動クリア
- **チャット管理ページ訪問**: メッセージバッジ自動クリア
- **設定永続化**: localStorage に保存

## 技術実装

### 通知コンテキスト
```typescript
interface NotificationCounts {
  applications: number;
  messages: number;
  total: number;
}

interface NotificationContextType {
  counts: NotificationCounts;
  updateApplicationCount: (count: number) => void;
  updateMessageCount: (count: number) => void;
  clearApplicationCount: () => void;
  clearMessageCount: () => void;
  clearAllCounts: () => void;
  showApplicationNotification: (applicantName: string, jobTitle: string) => void;
  showMessageNotification: (senderName: string) => void;
}
```

### バッジコンポーネント
```typescript
// 個別バッジ
<NotificationBadge count={counts.applications} type="application" />

// 統合バッジ
<CombinedNotificationBadge />
```

### 通知トリガー
```typescript
// 応募時の通知
showApplicationNotification(applicantName, jobTitle);
updateApplicationCount(1);

// メッセージ受信時の通知
showMessageNotification(senderName);
updateMessageCount(1);
```

## ユーザー体験フロー

### 応募通知フロー
1. **求職者が応募**
2. **応募処理完了**
3. **トースト通知表示**：「新しい応募: [求職者名]さんから「[求人タイトル]」への応募がありました」
4. **バッジ更新**：応募管理メニューに赤いバッジ表示
5. **企業が応募管理ページ訪問**：バッジ自動クリア

### メッセージ通知フロー
1. **求職者がメッセージ送信**
2. **Socket.IO でリアルタイム受信**
3. **トースト通知表示**：「新しいメッセージ: [送信者名]さんからメッセージが届きました」
4. **バッジ更新**：チャット管理メニューに赤いバッジ表示
5. **企業がチャット管理ページ訪問**：バッジ自動クリア

### マイページ外での通知
1. **応募またはメッセージ受信**
2. **トースト通知表示**
3. **ヘッダーアバターに統合バッジ表示**（応募数 + メッセージ数）
4. **マイページ訪問時**：統合バッジ非表示、個別バッジ表示

## 設定と永続化

### localStorage 構造
```json
{
  "notification_counts_123": {
    "applications": 3,
    "messages": 2,
    "total": 5,
    "updatedAt": "2024-01-15T10:30:00.000Z"
  }
}
```

### 自動保存
- バッジカウント変更時
- ユーザーID別に保存
- ブラウザセッション間で永続化

## リアルタイム機能

### 現在の実装
- **応募通知**: フロントエンドでシミュレーション
- **メッセージ通知**: Socket.IO を使用したリアルタイム受信

### 将来の拡張
- WebSocket による真のリアルタイム通知
- サーバーサイドでの通知キュー管理
- プッシュ通知の統合

## レスポンシブ対応

### モバイル対応
- バッジサイズの調整
- タッチフレンドリーな表示
- モバイルサイドバーでの適切な表示

### デスクトップ対応
- ホバー効果
- マウスオーバーでの詳細表示
- 適切なスペーシング

## セキュリティ考慮事項

### アクセス制御
- 企業・管理者のみ通知表示
- ユーザーID別の通知管理
- 適切な認証チェック

### データ保護
- localStorage の適切な使用
- 個人情報の最小限の保存
- セッション管理

## パフォーマンス最適化

### 効率的な更新
- 必要な時のみバッジ更新
- 不要な再レンダリングの防止
- メモ化の活用

### メモリ管理
- 適切なクリーンアップ
- イベントリスナーの適切な削除
- メモリリークの防止

## トラブルシューティング

### よくある問題
1. **バッジが表示されない**
   - ユーザーロールの確認
   - 通知コンテキストの初期化確認

2. **通知が消えない**
   - ページ遷移の確認
   - クリーンアップフックの動作確認

3. **トースト通知が表示されない**
   - ToastContainer の設定確認
   - 通知コンテキストの状態確認

### デバッグ方法
```javascript
// ブラウザコンソールでの状態確認
console.log(notificationContext.counts);

// 手動での通知テスト
showApplicationNotification('テスト求職者', 'テスト求人');
```

## 今後の拡張予定

### 機能拡張
- 通知履歴の表示
- 通知設定のカスタマイズ
- 音声通知の追加
- プッシュ通知の統合

### 技術改善
- 真のリアルタイム通知
- 通知キューの実装
- パフォーマンスの最適化
- アクセシビリティの向上

## まとめ

この実装により、企業は求職者からの応募やメッセージを確実に把握でき、迅速な対応が可能になります。バッジ表示とトースト通知により、見逃しを防ぎ、効率的なコミュニケーション管理を実現します。

